name: üöÄ Deploy Backend to Production

on:
  push:
    branches:
      - deployment/docker-nginx
  workflow_dispatch:  # Permite deploy manual desde GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Backend to service.voyager.andrescortes.dev
    timeout-minutes: 15  # Timeout de seguridad
    
    steps:
      # ==========================================
      # Pre-deployment Checks
      # ==========================================
      - name: üìã Deployment Info
        run: |
          echo "üöÄ Starting deployment to Production"
          echo "üìÖ Date: $(date)"
          echo "üîñ Commit: ${{ github.sha }}"
          echo "üë§ Triggered by: ${{ github.actor }}"
          echo "========================================="
      
      # ==========================================
      # Main Deployment via SSH
      # ==========================================
      - name: üöÄ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 10m
          command_timeout: 10m
          script: |
            echo "üì¶ Starting backend deployment..."
            echo "========================================="
            
            cd ~/Voyager-cloudDB-Back
            
            # ==========================================
            # PASO 1: Pre-deployment Checks
            # ==========================================
            echo "üîç Running pre-deployment checks..."
            
            # Verificar espacio en disco (m√≠nimo 2GB libre)
            AVAILABLE_SPACE=$(df -BG . | tail -1 | awk '{print $4}' | sed 's/G//')
            if [ "$AVAILABLE_SPACE" -lt 2 ]; then
              echo "‚ùå ERROR: Insufficient disk space (${AVAILABLE_SPACE}GB available)"
              exit 1
            fi
            echo "‚úÖ Disk space OK: ${AVAILABLE_SPACE}GB available"
            
            # Verificar memoria disponible
            FREE_MEM=$(free -m | awk 'NR==2 {print $7}')
            if [ "$FREE_MEM" -lt 500 ]; then
              echo "‚ö†Ô∏è WARNING: Low memory (${FREE_MEM}MB available)"
            fi
            echo "‚úÖ Memory check: ${FREE_MEM}MB available"
            
            # ==========================================
            # PASO 2: Backup del contenedor actual
            # ==========================================
            echo "üíæ Creating backup of current backend..."
            if docker ps -a | grep -q crudclouddb_backend; then
              docker commit crudclouddb_backend crudclouddb-api:backup-$(date +%Y%m%d-%H%M%S) || true
              echo "‚úÖ Backup created"
            else
              echo "‚ÑπÔ∏è  No existing container to backup"
            fi
            
            # ==========================================
            # PASO 3: Pull del c√≥digo m√°s reciente
            # ==========================================
            echo "‚¨áÔ∏è  Pulling latest code..."
            git fetch origin deployment/docker-nginx
            git reset --hard origin/deployment/docker-nginx
            git clean -fd
            echo "‚úÖ Code updated"
            
            # ==========================================
            # PASO 4: Iniciar/Verificar Bases de Datos
            # ==========================================
            echo "üóÑÔ∏è  Checking database containers..."
            
            # Verificar si el archivo compose de DBs existe
            if [ -f "docker-compose.databases.yml" ]; then
              # Iniciar bases de datos si no est√°n corriendo
              docker compose -f docker-compose.databases.yml up -d
              
              echo "‚è≥ Waiting for databases to be ready..."
              sleep 15
              
              # Verificar salud de cada base de datos
              for DB in postgres_master mysql_master mongodb_master sqlserver_master; do
                if docker ps | grep -q $DB; then
                  echo "‚úÖ $DB is running"
                else
                  echo "‚ö†Ô∏è WARNING: $DB is not running"
                fi
              done
            else
              echo "‚ÑπÔ∏è  No databases compose file found, skipping DB management"
            fi
            
            # ==========================================
            # PASO 5: Construcci√≥n de la imagen del backend
            # ==========================================
            echo "üî® Building Docker image..."
            
            # Etiquetar imagen anterior como 'previous' para rollback
            if docker images | grep -q "crudclouddb-api.*latest"; then
              docker tag crudclouddb-api:latest crudclouddb-api:previous || true
            fi
            
            # Build con cache para acelerar
            docker build \
              --tag crudclouddb-api:latest \
              --tag crudclouddb-api:${{ github.sha }} \
              --cache-from crudclouddb-api:latest \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              . || {
                echo "‚ùå ERROR: Docker build failed"
                exit 1
              }
            
            echo "‚úÖ Image built successfully"
            
            # ==========================================
            # PASO 6: Detener contenedor actual (Graceful Shutdown)
            # ==========================================
            echo "üõë Stopping current backend container..."
            
            if docker ps | grep -q crudclouddb_backend; then
              # Dar 30 segundos para shutdown graceful
              docker stop -t 30 crudclouddb_backend || true
              docker rm crudclouddb_backend || true
              echo "‚úÖ Old container stopped and removed"
            else
              echo "‚ÑπÔ∏è  No running container to stop"
            fi
            
            # ==========================================
            # PASO 7: Iniciar nuevo contenedor backend
            # ==========================================
            echo "‚ñ∂Ô∏è  Starting new backend container..."
            docker run -d \
              --name crudclouddb_backend \
              --restart unless-stopped \
              --network voyager_network \
              --cpus="1.0" \
              --memory="512m" \
              --memory-swap="768m" \
              --memory-reservation="256m" \
              --health-cmd="curl -f http://localhost:5191/health || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              --health-start-period=40s \
              -p 5191:5191 \
              -v /var/run/docker.sock:/var/run/docker.sock \
              -e ASPNETCORE_ENVIRONMENT=Production \
              -e ASPNETCORE_URLS=http://+:5191 \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_PORT=${{ secrets.DB_PORT }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e JWT_ISSUER=CrudCloudDb.API \
              -e JWT_AUDIENCE=CrudCloudDb.Frontend \
              -e SMTP_SERVER=smtp.gmail.com \
              -e SMTP_PORT=587 \
              -e SMTP_SENDER_EMAIL=${{ secrets.SMTP_SENDER_EMAIL }} \
              -e SMTP_SENDER_NAME=PotterCloud \
              -e SMTP_USERNAME=${{ secrets.SMTP_USERNAME }} \
              -e SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }} \
              -e SMTP_ENABLE_SSL=true \
              -e DB_HOST_POSTGRESQL=${{ secrets.DB_HOST_POSTGRESQL }} \
              -e DB_HOST_MYSQL=${{ secrets.DB_HOST_MYSQL }} \
              -e DB_HOST_MONGODB=${{ secrets.DB_HOST_MONGODB }} \
              -e DB_HOST_SQLSERVER=${{ secrets.DB_HOST_SQLSERVER }} \
              -e DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }} \
              -e MERCADOPAGO_ACCESS_TOKEN=${{ secrets.MERCADOPAGO_ACCESS_TOKEN }} \
              -e MERCADOPAGO_PUBLIC_KEY=${{ secrets.MERCADOPAGO_PUBLIC_KEY }} \
              -e MERCADOPAGO_NOTIFICATION_URL=${{ secrets.MERCADOPAGO_NOTIFICATION_URL }} \
              -e MERCADOPAGO_WEBHOOK_SECRET=${{ secrets.MERCADOPAGO_WEBHOOK_SECRET }} \
              crudclouddb-api:latest || {
                echo "‚ùå ERROR: Failed to start backend container"
                echo "üìã Attempting rollback..."
                
                # Rollback a imagen anterior
                if docker images | grep -q "crudclouddb-api.*previous"; then
                  docker run -d \
                    --name crudclouddb_backend \
                    --restart unless-stopped \
                    --network voyager_network \
                    -p 5191:5191 \
                    -v /var/run/docker.sock:/var/run/docker.sock \
                    $(docker inspect --format='{{range .Config.Env}}{{printf "-e %s " .}}{{end}}' crudclouddb_backend 2>/dev/null || echo "") \
                    crudclouddb-api:previous
                  
                  echo "‚ö†Ô∏è Rollback completed to previous version"
                fi
                
                exit 1
              }
            
            echo "‚úÖ Backend container started"
            echo "‚úÖ Backend container started"
            
            # ==========================================
            # PASO 8: Health Checks del Backend
            # ==========================================
            echo "üè• Running health checks..."
            
            # Esperar 30 segundos para que el backend inicie completamente
            echo "‚è≥ Waiting 30s for backend to be ready..."
            sleep 30
            
            # Intentar health check 5 veces con intervalo de 10s
            HEALTH_CHECK_ATTEMPTS=5
            HEALTH_CHECK_PASSED=false
            
            for i in $(seq 1 $HEALTH_CHECK_ATTEMPTS); do
              echo "Attempt $i/$HEALTH_CHECK_ATTEMPTS..."
              
              if docker exec crudclouddb_backend curl -f http://localhost:5191/health; then
                echo "‚úÖ Backend health check passed"
                HEALTH_CHECK_PASSED=true
                break
              else
                echo "‚ö†Ô∏è Health check failed, retrying in 10s..."
                sleep 10
              fi
            done
            
            if [ "$HEALTH_CHECK_PASSED" = false ]; then
              echo "‚ùå ERROR: Backend health check failed after $HEALTH_CHECK_ATTEMPTS attempts"
              echo "üìã Backend logs:"
              docker logs --tail 50 crudclouddb_backend
              
              # Intentar rollback
              echo "üîÑ Attempting rollback..."
              docker stop crudclouddb_backend && docker rm crudclouddb_backend
              
              if docker images | grep -q "crudclouddb-api.*previous"; then
                docker run -d --name crudclouddb_backend --restart unless-stopped --network voyager_network -p 5191:5191 crudclouddb-api:previous
                echo "‚ö†Ô∏è Rolled back to previous version"
              fi
              
              exit 1
            fi
            
            # ==========================================
            # PASO 9: Iniciar/Reiniciar NGINX
            # ==========================================
            echo "üåê Starting/Reloading NGINX..."
            
            # Verificar si NGINX est√° corriendo
            if docker ps | grep -q voyager-backend-nginx; then
              echo "‚ôªÔ∏è  Reloading NGINX configuration..."
              docker exec voyager-backend-nginx nginx -s reload || {
                echo "‚ö†Ô∏è NGINX reload failed, restarting container..."
                docker-compose restart nginx
              }
            else
              echo "‚ñ∂Ô∏è  Starting NGINX..."
              docker-compose up -d nginx
            fi
            
            echo "‚è≥ Waiting for NGINX..."
            sleep 5
            
            # ==========================================
            # PASO 10: Test Final v√≠a NGINX
            # ==========================================
            echo "üß™ Testing via NGINX (port 80)..."
            
            if curl -f http://localhost/health; then
              echo "‚úÖ NGINX health check passed"
            else
              echo "‚ö†Ô∏è WARNING: NGINX health check failed (may be due to SSL redirect)"
              echo "‚ÑπÔ∏è  Backend is running, NGINX may need SSL verification"
            fi
            
            # ==========================================
            # PASO 11: Limpieza
            # ==========================================
            echo "üßπ Cleaning up old images..."
            
            # Eliminar im√°genes sin tag y antiguas
            docker image prune -f
            
            # Mantener solo las √∫ltimas 3 versiones
            docker images | grep crudclouddb-api | awk '{print $3}' | tail -n +4 | xargs -r docker rmi -f || true
            
            # ==========================================
            # PASO 12: Verificaci√≥n Final
            # ==========================================
            echo "========================================="
            echo "üìä Deployment Summary:"
            echo "========================================="
            
            echo ""
            echo "üìã Container Status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "crudclouddb_backend|voyager-backend-nginx|postgres_master|mysql_master|mongodb_master|sqlserver_master"
            
            echo ""
            echo "üíæ Memory Usage:"
            docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}\t{{.CPUPerc}}"
            
            echo ""
            echo "üìã Recent Backend Logs:"
            docker logs --tail 30 crudclouddb_backend
            
            echo ""
            echo "========================================="
            echo "‚úÖ Deployment completed successfully!"
            echo "========================================="
            echo "üåê Backend API: https://service.voyager.andrescortes.dev"
            echo "üìö Swagger: https://service.voyager.andrescortes.dev/swagger"
            echo "üè• Health: https://service.voyager.andrescortes.dev/health"
            echo "========================================="
      
      # ==========================================
      # Post-Deployment Notification
      # ==========================================
      - name: üì¢ Notify Deployment Success
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
      
      - name: üì¢ Notify Deployment Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Commit: ${{ github.sha }}"
          echo "Check logs for details"
